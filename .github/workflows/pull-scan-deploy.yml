
name: CI/CD -> SonarQube -> (Trivy optional) -> EKS -> Apply Manifests

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Docker Hub image tag (default: latest)"
        required: false
        default: "latest"
      enable_public_endpoint:
        description: "Temporarily enable EKS public endpoint (restricted to runner IP)"
        type: boolean
        required: false
        default: false

# Prevent overlapping deploy runs on the same ref
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  # ---- Image settings ----
  IMAGE_REPO: devenops641/endhunger
  IMAGE_TAG: latest

  # ---- Kubernetes settings ----
  K8S_NAMESPACE: default
  K8S_DEPLOYMENT: endhunger
  K8S_CONTAINER: endhunger

  # ---- Cluster settings ----
  CLUSTER_NAME: endhunger-eks
  AWS_REGION: us-east-1

jobs:
  deploy:
    runs-on: self-hosted
    # If you registered labels on the runner, use:
    # runs-on: [ self-hosted, linux, eks ]

    # Expose Sonar secrets to env so we can safely test them in `if:`
    env:
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SONAR_TOKEN:    ${{ secrets.SONAR_TOKEN }}

    steps:
      # 1) Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Set IMAGE_TAG (from workflow_dispatch input)
      - name: Set IMAGE_TAG
        shell: bash
        run: |
          TAG="${{ github.event.inputs.image_tag }}"
          if [ -z "$TAG" ]; then TAG="latest"; fi
          echo "IMAGE_TAG=$TAG" >> "$GITHUB_ENV"
          echo "Using image: ${{ env.IMAGE_REPO }}:$TAG"

      # 3) Install kubectl
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      # 4) Pull Docker image (sanity check the tag exists)
      - name: Pull Docker image
        run: |
          echo "Pulling ${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}"
          docker pull ${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}

      # 5) SonarQube reachability guard (sets RUN_SONAR=true/false)
      - name: Check SonarQube reachability
        run: |
          if [ -z "$SONAR_HOST_URL" ] || [ -z "$SONAR_TOKEN" ]; then
            echo "SonarQube secrets not set; skipping scan."
            echo "RUN_SONAR=false" >> "$GITHUB_ENV"
